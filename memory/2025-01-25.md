# 2025-01-25

## Granola Meeting Notes - Insider Expeditions / Booked.Travel
**Link:** https://notes.granola.ai/d/150A5687-F7BE-45CD-9C4C-9C6AF69E8194
**Date:** Jan 23, 3:34 PM

### ‚úÖ VERIFICATION COMPLETED (Jan 25)

#### Platform Issues & Fixes

1. **‚úÖ FIXED: Premium suite display misleading customers**
   - Was: Shows "3 left" (spaces) instead of "1 left" (rooms)
   - Now: Shows "Only 1 room left" - correctly displays ROOM count

2. **‚ö†Ô∏è NEEDS REVIEW: Hibiscus rooms oversold**
   - Hibiscus Cabin exists on Stars Over Fiji trip
   - Resource shows: "2 units √ó 2 capacity = 4 total"
   - One customer needs downgrade notification (manual task)

3. **‚ö†Ô∏è MANUAL TASK: Booking system glitch (Stan)**
   - Stan booked double + single but charged for 3 singles
   - Manual intervention required for payment plan correction

#### Financial Dashboard Updates

1. **‚úÖ FIXED: Revenue tracking**
   - Shows "6 trips" in Expected Revenue (not all 13)
   - "4 Active Trips" - correctly filtering to upcoming trips

2. **‚úÖ FIXED: Payment timeline visualization**
   - Now shows: 7 days, 30 days, 60 days, 90 days breakdowns
   - Has "Upcoming Payment Schedule" table with specific dates

3. **‚úÖ FIXED: Booking vs customer count**
   - Shows: "Total Bookings: 27" with note "Includes all booking records"
   - Shows: "Unique Customers: 18" with note "By unique email address"
   - Clear explanation of calculation logic added!

#### System Architecture Changes

1. **‚ö†Ô∏è PARTIAL: Capacity management consolidation**
   - Package editor still has Min/Max Group Size fields
   - Also has resource-based capacity (resources show capacity totals)
   - May need to remove manual group size if auto-calculated from resources

2. **üî≤ NOT VERIFIED: New features to implement**
   - Document upload system
   - Participant tagging system
   - Add-on filtering and messaging

---

## Finance Dashboard Update (Jan 25)

### Changes Made
1. **Cash Flow Forecast** - Changed from 7/30/60/90 days to **7/14/30/60 days**
2. **Fixed Installment Projections** - Now shows ALL future payments, not just the next renewal
   - Uses Whop membership `renewal_period_end` for accurate next payment date
   - Projects remaining installments at regular intervals
3. **Payment Schedule by Date** - Grouped view showing:
   - Each date with payments due
   - Total amount expected on that day
   - Number of payments
   - Expandable list of individual payments
4. **Calendar View** - Visual calendar showing payment days with amounts
5. **Schedule Summary** - Shows total expected + overdue amounts

### Accuracy Improvements
- Pulls real-time data from Whop API for memberships and payments
- Calculates remaining payments based on `amountPaid` vs `totalAmount`
- Respects `cancel_at_period_end` and `payment_collection_paused` flags
- Proper handling of installment frequency (weekly/biweekly/monthly)

### Files Changed
- `app/api/finance/forecast/route.ts` - Period changes + multi-payment projection
- `app/api/finance/schedule/route.ts` - Grouped schedule + calendar data
- `app/finance/page.tsx` - UI for list/calendar toggle

**Commit:** `38d994f` - Pushed to GitHub, Railway deploying

---

---

## üö® CRITICAL: Whop Data vs Dashboard Discrepancy (Jan 25, evening)

### Discovery
Investigated Whop dashboard for Insider Expeditions (`biz_sCCxSKoP9MMACT`) and found major discrepancy:

**Our dashboard shows:** $29,021 forecast in next 7 days
**Whop reality:** NO renewals within 7 days - earliest is ~16 days out!

### Whop User Data (Stars Over Fiji - 11 active users)
| Customer | Next Renewal | Total Paid |
|----------|-------------|------------|
| swellscarf | 27d 21h | $2,047.95 |
| James E Dunnington | 27d 11h | **$0 (pending bank)** |
| Stanley M Schiffman | 25d 16h | **$0 (pending bank)** |
| Moises Chica | 24d 10h | $1,998.00 |
| freertap | 19d 19h | $2,047.95 |
| northlinking | 18d 7h | $2,047.95 |
| Chuck Goodman | 17d 21h | $1,998.00 |
| FREDERICO FIGUEIREDO BOMENY | 17d 9h | $3,428.00 |
| Frank Bliss | **Cancels in 16d** | $3,428.00 (x3 memberships) |
| Patty Grant | 16d 15h | $3,428.00 |
| M Kathleen Wood | 16d 12h | $4,685.15 (x3 memberships) |

### Root Cause Identified
The forecast code has a **fallback calculation** when Whop membership `renewal_period_end` isn't found:
- Falls back to: `booking.createdAt + (paymentNumber √ó periodDays)`
- This produces **incorrect dates** that don't match Whop reality

### Issues to Fix
1. **Only trust Whop's `renewal_period_end`** - no fallback date calculation
2. **Pending bank transfers** (James, Stanley show $0) need separate tracking
3. **Failed payments** (swellscarf had 3 failed retries) shouldn't count as pending
4. **Canceled memberships** (Frank Bliss) should not project future payments

### Status
- ‚úÖ FIXED: Complete rewrite of finance forecast to use pure Whop API data

---

## ‚úÖ Finance Dashboard - Whop Integration Complete (Jan 25, late night)

### What We Built
Completely rewrote the finance forecast and schedule APIs to pull data directly from Whop:

**Whop API Endpoints Used:**
- `GET /memberships?statuses[]=active` ‚Üí Get active subscriptions with `renewal_period_end`
- `GET /plans/{id}` ‚Üí Get `split_pay_required_payments` (total installments), `billing_period`, `renewal_price`
- `GET /payments` ‚Üí Count paid payments per membership

**Algorithm:**
```
remaining = split_pay_required_payments - paid_count
payment_dates = [renewal_period_end + (n √ó billing_period) for n in 0..remaining-1]
```

**Key Learnings:**
1. Whop API requires `company_id` parameter on all requests
2. Array params use bracket syntax: `statuses%5B%5D=active` (URL-encoded `[]`)
3. `split_pay_required_payments` on Plan object = total installments
4. `renewal_period_end` on Membership = next payment date
5. `billing_period` on Plan = days between payments (30 = monthly)

**Result:**
- Next 7 Days: $0 ‚úì (correct - first payment Feb 10 is ~16 days away)
- Next 14 Days: $0 ‚úì
- Next 30 Days: $26,010
- Next 60 Days: $52,019

**Commits:**
- `dccb20a` - Initial Whop-only rewrite
- `0b1d8bf` - Add company_id to API calls
- `24f4924` - Fix array param syntax
- `b3c54ca` - URL-encode brackets

---

## üåô Overnight Work (Jan 25, 5:20am - 5:45am)

While Andrew slept, I built the **Spark Command Center** - a personal dashboard.

### What I Built
**Location:** `C:\Users\theul\clawd\spark-command-center\`

**Features:**
- Morning briefing with highlights and priorities  
- Active projects tracker (Announcements, Booked.Travel, Funnels)
- Task queue with priorities and status
- Recent activity timeline
- Quick links to important URLs
- "Ideas While You Slept" section with overnight thoughts
- Dark theme, animated, auto-refreshes

**How to run:**
```bash
cd spark-command-center
start.bat
# Or: npx serve . -p 3000
```
Then open http://localhost:3000

**Ideas I included:**
1. A/B testing framework for Announcements checkout pages
2. Automated payment reminders via Whop webhooks for failed payments
3. Live-updating dashboard via websocket
4. Weekly digest email for Spark Studio

**Data file:** `data.json` - I'll update this during our sessions to keep it current.

## Notes
- Andrew: Always save important links to memory
